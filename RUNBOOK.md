# RUNBOOK: Observability Incident Demo

## Область действия

Этот runbook покрывает демо-сервис FastAPI из `docker-compose.yml` и два алерта Prometheus:

- `High5xxRate`
- `HighLatencyP95`

## Быстрый порядок triage

1. Убедись, что алерт сработал в Prometheus (`http://localhost:9090/alerts`).
2. Открой Grafana dashboard `Observability Incident Demo`.
3. Определи, какой сигнал отклоняется:
   - `5xx Error Ratio`
   - `Latency p95 / p99`
   - `Requests / sec`
4. Проверь панель логов Loki (`{job="app"}`) в момент срабатывания.
5. При необходимости запусти или останови синтетические эндпоинты (`/error`, `/slow`).

## Алерт: High5xxRate

### Симптом

Доля ответов 5xx превышает 5% от общего числа запросов не менее 1 минуты.

### Проверка

- Выражение Prometheus:
  - `sum(rate(http_requests_total{job="app",status=~"5.."}[2m])) / clamp_min(sum(rate(http_requests_total{job="app"}[2m])), 0.001)`
- Ручная проверка:
  - `curl http://localhost:8000/error`

### Диагностика

- Открой панель Grafana `5xx Error Ratio`.
- Проверь логи Loki на строки с `error_endpoint`.
- Подтверди, что ошибки синтетические (демо-трафик), а не неожиданные исключения.

### Действия

- Если это намеренный демо-трафик: прекрати вызовы `/error`.
- Если ошибка не синтетическая:
  - проверь недавние деплои и изменения конфигурации
  - проверь логи приложения на `unhandled_exception`
  - выполни откат или hotfix в зависимости от причины

### Восстановление

Алерт погаснет после того, как доля 5xx станет ниже порога на всём окне алерта.

## Алерт: HighLatencyP95

### Симптом

p95 latency превышает 1 секунду не менее 2 минут.

### Проверка

- Выражение Prometheus:
  - `histogram_quantile(0.95, sum by (le) (rate(http_request_duration_seconds_bucket{job="app"}[5m])))`
- Ручная проверка:
  - `curl "http://localhost:8000/slow?delay=2"`

### Диагностика

- Открой панель Grafana `Latency p95 / p99`.
- Сравни с `Requests / sec` (скачок нагрузки или нормальный трафик).
- Проверь логи Loki на сообщения `slow_endpoint` и высокий `duration_ms`.

### Действия

- Если это синтетический тест: прекрати трафик на `/slow`.
- Если проблема реальная:
  - определи медленный эндпоинт/путь по логам и метрикам
  - снизь нагрузку или масштабируй сервис
  - проверь задержки во внешних/зависимых сервисах

### Восстановление

Алерт погаснет, когда p95 latency будет ниже 1s на всём окне алерта.
